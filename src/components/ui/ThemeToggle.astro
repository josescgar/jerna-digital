---
import {
  getTranslations,
  defaultLanguage,
  type Language,
} from '@/i18n/translations';

interface Props {
  lang?: Language;
  class?: string;
}

const lang = Astro.props.lang ?? defaultLanguage;
const t = getTranslations(lang);
const className = Astro.props.class ?? '';
---

<button
  type="button"
  class:list={[
    'theme-toggle text-foreground-muted hover:bg-background-subtle hover:text-foreground flex h-10 w-10 items-center justify-center rounded-lg transition-colors',
    className,
  ]}
  aria-label={t.themeSwitcher.toggleTheme}
  data-theme-toggle
>
  <!-- Sun icon - shown in dark mode (click to switch to light) -->
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="20"
    height="20"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="sun-icon hidden"
    aria-hidden="true"
  >
    <circle cx="12" cy="12" r="4"></circle>
    <path d="M12 2v2"></path>
    <path d="M12 20v2"></path>
    <path d="m4.93 4.93 1.41 1.41"></path>
    <path d="m17.66 17.66 1.41 1.41"></path>
    <path d="M2 12h2"></path>
    <path d="M20 12h2"></path>
    <path d="m6.34 17.66-1.41 1.41"></path>
    <path d="m19.07 4.93-1.41 1.41"></path>
  </svg>
  <!-- Moon icon - shown in light mode (click to switch to dark) -->
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="20"
    height="20"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="moon-icon hidden"
    aria-hidden="true"
  >
    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
  </svg>
</button>

<script>
  function initThemeToggle(): void {
    const toggleButtons = document.querySelectorAll('[data-theme-toggle]');

    function updateIcons(): void {
      const theme = document.documentElement.getAttribute('data-theme');
      toggleButtons.forEach((btn) => {
        const sunIcon = btn.querySelector('.sun-icon');
        const moonIcon = btn.querySelector('.moon-icon');

        if (theme === 'light') {
          // In light mode, show moon icon (click to go dark)
          sunIcon?.classList.add('hidden');
          moonIcon?.classList.remove('hidden');
        } else {
          // In dark mode, show sun icon (click to go light)
          sunIcon?.classList.remove('hidden');
          moonIcon?.classList.add('hidden');
        }
      });
    }

    function toggleTheme(): void {
      const currentTheme =
        document.documentElement.getAttribute('data-theme') === 'light'
          ? 'light'
          : 'dark';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';

      try {
        localStorage.setItem('jerna-theme', newTheme);
      } catch {
        // localStorage might be blocked
      }

      document.documentElement.setAttribute('data-theme', newTheme);
      updateIcons();
    }

    // Initialize icons based on current theme
    updateIcons();

    // Add click handlers
    toggleButtons.forEach((btn) => {
      btn.addEventListener('click', toggleTheme);
    });

    // Listen for system preference changes
    window
      .matchMedia('(prefers-color-scheme: light)')
      .addEventListener('change', (e) => {
        // Only update if no stored preference
        if (!localStorage.getItem('jerna-theme')) {
          const newTheme = e.matches ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          updateIcons();
        }
      });
  }

  // Run on initial load
  initThemeToggle();

  // Re-run on view transitions (Astro navigation)
  document.addEventListener('astro:after-swap', initThemeToggle);
</script>
