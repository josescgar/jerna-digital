---
import {
  getTranslations,
  languages,
  defaultLanguage,
  type Language,
} from '@/i18n/translations';
import { getLocalizedPath } from '@/i18n/utils';
import Logo from './Logo.astro';

interface Props {
  lang?: Language;
}

const lang = Astro.props.lang ?? defaultLanguage;
const t = getTranslations(lang);

interface NavItem {
  label: string;
  href: string;
}

const navItems: NavItem[] = [
  { label: t.nav.about, href: getLocalizedPath(lang, '/about') },
  { label: t.nav.services, href: getLocalizedPath(lang, '/services') },
  { label: t.nav.caseStudies, href: getLocalizedPath(lang, '/case-studies') },
  { label: t.nav.contact, href: getLocalizedPath(lang, '/contact') },
];

const homeHref = getLocalizedPath(lang, '/');
const contactHref = getLocalizedPath(lang, '/contact');

// Get current path without language prefix for language switching
const currentPath = Astro.url.pathname.replace(/^\/(en|es)(?=\/|$)/, '') || '/';
---

<header class="fixed top-0 right-0 left-0 z-30" id="site-header">
  <div class="glass">
    <nav class="container flex h-16 items-center justify-between md:h-20">
      <a
        href={homeHref}
        class="flex items-center gap-2 transition-opacity hover:opacity-80"
        aria-label={t.site.name}
      >
        <Logo />
      </a>

      <!-- Desktop Navigation -->
      <ul class="hidden items-center gap-1 md:flex">
        {
          navItems.map((item) => (
            <li>
              <a
                href={item.href}
                class="text-foreground-muted hover:bg-background-subtle hover:text-foreground rounded-lg px-4 py-2 text-sm font-medium transition-colors"
              >
                {item.label}
              </a>
            </li>
          ))
        }

        <!-- Language Switcher (Desktop) -->
        <li class="relative ml-2">
          <button
            type="button"
            class="text-foreground-muted hover:bg-background-subtle hover:text-foreground flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium transition-colors"
            id="lang-switcher-btn"
            aria-label={t.languageSwitcher.selectLanguage}
            aria-expanded="false"
            aria-haspopup="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
              <path d="M2 12h20"></path>
            </svg>
            <span class="uppercase">{lang}</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </button>
          <div
            class="border-border bg-background-elevated absolute right-0 mt-2 hidden min-w-[120px] rounded-lg border py-1 shadow-lg"
            id="lang-switcher-menu"
            role="menu"
          >
            {
              (Object.keys(languages) as Language[]).map((langKey) => (
                <a
                  href={getLocalizedPath(langKey, currentPath)}
                  class={`hover:bg-background-subtle flex items-center gap-2 px-4 py-2 text-sm transition-colors ${
                    langKey === lang
                      ? 'text-primary font-medium'
                      : 'text-foreground-muted'
                  }`}
                  role="menuitem"
                  data-lang={langKey}
                >
                  {langKey === lang && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="m9 12 2 2 4-4" />
                    </svg>
                  )}
                  <span class={langKey !== lang ? 'ml-[22px]' : ''}>
                    {languages[langKey]}
                  </span>
                </a>
              ))
            }
          </div>
        </li>

        <li class="ml-2">
          <a
            href={contactHref}
            class="bg-gradient-primary text-primary-foreground hover:shadow-glow inline-flex h-10 items-center justify-center rounded-lg px-5 text-sm font-medium transition-all hover:scale-[1.02]"
          >
            {t.hero.cta}
          </a>
        </li>
      </ul>

      <!-- Mobile Menu Button -->
      <button
        type="button"
        class="text-foreground-muted hover:bg-background-subtle hover:text-foreground flex h-10 w-10 items-center justify-center rounded-lg transition-colors md:hidden"
        id="mobile-menu-btn"
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="menu-icon"
        >
          <line x1="4" x2="20" y1="12" y2="12"></line>
          <line x1="4" x2="20" y1="6" y2="6"></line>
          <line x1="4" x2="20" y1="18" y2="18"></line>
        </svg>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="close-icon hidden"
        >
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </button>
    </nav>
  </div>

  <!-- Mobile Menu -->
  <div
    class="glass relative z-50 hidden md:hidden"
    id="mobile-menu"
    aria-hidden="true"
  >
    <nav class="container py-4">
      <ul class="flex flex-col gap-2">
        {
          navItems.map((item) => (
            <li>
              <a
                href={item.href}
                class="text-foreground-muted hover:bg-background-subtle hover:text-foreground block rounded-lg px-4 py-3 text-base font-medium transition-colors"
              >
                {item.label}
              </a>
            </li>
          ))
        }

        <!-- Language Switcher (Mobile) -->
        <li class="border-border mt-2 border-t pt-4">
          <div
            class="text-foreground-subtle mb-2 px-4 text-xs font-semibold tracking-wider uppercase"
          >
            {t.languageSwitcher.label}
          </div>
          <div class="flex gap-2 px-4">
            {
              (Object.keys(languages) as Language[]).map((langKey) => (
                <a
                  href={getLocalizedPath(langKey, currentPath)}
                  class={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${
                    langKey === lang
                      ? 'bg-primary/10 text-primary'
                      : 'text-foreground-muted hover:bg-background-subtle hover:text-foreground'
                  }`}
                  data-lang={langKey}
                >
                  {languages[langKey]}
                </a>
              ))
            }
          </div>
        </li>

        <li class="mt-2">
          <a
            href={contactHref}
            class="bg-gradient-primary text-primary-foreground hover:shadow-glow flex h-12 items-center justify-center rounded-lg text-base font-medium transition-all"
          >
            {t.hero.cta}
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<script>
  // Mobile menu toggle
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = menuBtn?.querySelector('.menu-icon');
  const closeIcon = menuBtn?.querySelector('.close-icon');

  function toggleMenu(): void {
    const isExpanded = menuBtn?.getAttribute('aria-expanded') === 'true';

    menuBtn?.setAttribute('aria-expanded', String(!isExpanded));
    mobileMenu?.classList.toggle('hidden');
    mobileMenu?.setAttribute('aria-hidden', String(isExpanded));
    menuIcon?.classList.toggle('hidden');
    closeIcon?.classList.toggle('hidden');

    // Prevent body scroll when menu is open
    document.body.style.overflow = isExpanded ? '' : 'hidden';
  }

  menuBtn?.addEventListener('click', toggleMenu);

  // Close menu on escape key
  document.addEventListener('keydown', (e) => {
    if (
      e.key === 'Escape' &&
      menuBtn?.getAttribute('aria-expanded') === 'true'
    ) {
      toggleMenu();
    }
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as Node;
    if (
      menuBtn?.getAttribute('aria-expanded') === 'true' &&
      !mobileMenu?.contains(target) &&
      !menuBtn?.contains(target)
    ) {
      toggleMenu();
    }
  });

  // Language switcher dropdown (desktop)
  const langBtn = document.getElementById('lang-switcher-btn');
  const langMenu = document.getElementById('lang-switcher-menu');

  function toggleLangMenu(): void {
    const isExpanded = langBtn?.getAttribute('aria-expanded') === 'true';
    langBtn?.setAttribute('aria-expanded', String(!isExpanded));
    langMenu?.classList.toggle('hidden');
  }

  langBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleLangMenu();
  });

  // Close language menu when clicking outside
  document.addEventListener('click', () => {
    if (langBtn?.getAttribute('aria-expanded') === 'true') {
      toggleLangMenu();
    }
  });

  // Save language preference when clicking a language link
  document.querySelectorAll('[data-lang]').forEach((link) => {
    link.addEventListener('click', () => {
      const lang = (link as HTMLElement).dataset.lang;
      if (lang) {
        try {
          localStorage.setItem('jerna-lang', lang);
        } catch {
          // localStorage might be blocked
        }
      }
    });
  });
</script>
